{% extends 'base.html' %}

{% block content %}
<div class="w3-panel w3-card-4 w3-light-grey">
    <div class="w3-margin-top w3-margin-bottom">
        {{ m.section_title('Display') }}
        {{ m.question_mark('display_tooltip') }}
        {{ m.tooltip('display_tooltip', '''
            The display or X register shows the result after the execution of a program.
            The display history shows the values of the display register each time the program encounters the "2nd Pause" key.
            The real calculator would pause for a second whereas the emulator keeps track of the X register.
            In the Python code, the X register corresponds to the variable "x", and the display history is stored in the "regx" list.
            ''') }}

        {% if calculator_state.regx is defined and calculator_state.regx %}
        {{ m.toggle_buttons('display_register_show', 'display_history_show', 'History', 'Current',
            "toggle_x_y('display_history_show', 'display_register_show', 'display_register', 'display_history')") }}
        {% endif %}
    </div>

    <div id="display_register" class="w3-panel w3-white">
        <span class="w3-right">{{ calculator_state.fixed_x if calculator_state.fixed_x is defined else 0 }}</span>
    </div>

    <table id="display_history" class="w3-panel w3-white w3-table w3-striped w3-bordered" style="display: none">
        <tr class="w3-text-gray">
            <th>#</th>
            <th class="w3-right">X Register</th>
        </tr>
        {% for x in calculator_state.regx %}<tr>
            <td>{{ loop.index }}.</td>
            <td class="w3-right">{{ x }}</td>
        </tr>{% endfor %}
        <tr>
            <td>Current.</td>
            <td class="w3-right">{{ calculator_state.fixed_x if calculator_state.fixed_x is defined else 0 }}</td>
        </tr>
    </table>
</div>

<div class="w3-panel w3-card-4 w3-light-grey">
    <div class="w3-margin-top w3-margin-bottom">
        {{ m.section_title('Program') }}
        {{ m.question_mark('instructions_display_tooltip') }}
        {{ m.tooltip('instructions_display_tooltip', '''
            The program is a set of instructions just as they would be entered on a real calculator with the addition of comments starting with a #.
            The emulator translates the instructions into Python then executes the code and displays the result.
            ''') }}

        <span class="w3-right">
            <a class="link" href="{{ request.url }}" title="Refresh Program Instructions">
                <i class="fas fa-redo"></i>
            </a>
            <span class="w3-hide-small">&nbsp;</span>
            <a class="link" href="javascript: erase_instructions()" title="Erase Program Instructions">
                <i class="fas fa-trash"></i>
            </a>
            <span class="w3-hide-small">&nbsp;</span>
            <a class="link" href="javascript: document.getElementById('program').submit()"
                title="Run Program (Shortcut)">
                <i class="fas fa-cog"></i>
            </a>
            <span class="w3-hide-small">&nbsp;</span>
            <button id="edit" class="w3-button w3-amber w3-hover-indigo w3-small" onclick="toggle_highlight_edit()">
                Edit
            </button>
            <button id="highlight" class="w3-button w3-amber w3-hover-indigo w3-small"
                onclick="toggle_highlight_edit()">
                Highlight
            </button>
        </span>
    </div>

    <form id="program" method="post">
        {{ form.hidden_tag() }}

        {% if request.cookies.get('instructions_display', 'highlighted') == 'highlighted' %}
        {{ form.ti_instructions(class_='w3-input w3-panel', style='font-family: Consolas,"courier new";display: none;') }}
        {{ m.highlight_code('tiinstruction', 'highlighted', form.ti_instructions.data, display=True) }}
        {% else %}
        {{ form.ti_instructions(class_='w3-input w3-panel', style='font-family: Consolas,"courier new";') }}
        {{ m.highlight_code('tiinstruction', 'highlighted', form.ti_instructions.data, display=False) }}
        {% endif %}

        <p>
            {{ form.instruction_not_with_python(class_="w3-check") }}
            {{ form.instruction_not_with_python.label }}
        </p>
        <p class="w3-center">{{ form.run(class_='w3-button w3-amber w3-hover-indigo') }}</p>
    </form>
</div>

{% if py_code %}
<div class="w3-panel w3-card w3-light-grey">
    <div class="w3-margin-top w3-margin-bottom">
        {{ m.section_title('Python Code') }}
        {{ m.toggle_buttons('python_show', 'python_hide', 'Show', 'Hide',
            "toggle_x_y('python_show', 'python_hide', 'python_code')") }}
    </div>
    {{ m.highlight_code('python', 'python_code', py_code, display=False) }}
</div>

{% if calculator_state %}
<div class="w3-panel w3-card w3-light-grey">
    <div class="w3-margin-top w3-margin-bottom">
        {{ m.section_title('Internal State') }}
        {{ m.toggle_buttons('state_show', 'state_hide', 'Show', 'Hide',
            "toggle_x_y('state_show', 'state_hide', 'state_code')") }}
    </div>

    <div id="state_code" style="display: none">
        {{ m.section_value('Angle Unit (2nd Deg, Rad, Grad)', calculator_state.unit) }}
        {{ m.section_value('Scientific Notation (EE)', calculator_state.ee) }}
        {{ m.section_value('Rounding to n digits (2nd Fix)', calculator_state.rounding) }}
        {{ m.section_value('X Register (Display)', calculator_state.x) }}
        {{ m.section_value('Fixed X (rounding and EE)', calculator_state.fixed_x) }}
        {{ m.section_values('X Register History (2nd Pause)', calculator_state.regx) }}
        {{ m.section_values('Non-Zero Memories (STO)', calculator_state.mem, hide_zero_value=True) }}
        {{ m.section_values('Nested Operations Stack', calculator_state.stack) }}
        {{ m.section_value('Error Message', calculator_state.error) }}
    </div>
</div>
{% endif %}
{% endif %}

<script type="text/javascript">
    window.addEventListener("load", autofit_instructions_height);
    window.addEventListener("load", set_highlight_edit);
    window.addEventListener("resize", autofit_instructions_height);
    w3CodeColor();
</script>
{% endblock %}
